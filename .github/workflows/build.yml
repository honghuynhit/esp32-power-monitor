name: ESP32 Firmware Build & Deploy -- Redeploy

on:
  push:
    branches:
      - main
    paths:
      - '**.ino'
      - '**.cpp'
      - '**.h'
      - 'version.txt'
  workflow_dispatch:

# âœ… ADD THIS SECTION - Fixes the 403 permission error
permissions:
  contents: write  # Allow pushing to repository

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ”§ Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1
    
    - name: ðŸ“¦ Install ESP32 platform
      run: |
        arduino-cli config init
        arduino-cli core update-index
        arduino-cli core install esp32:esp32
    
    - name: ðŸ“– Read version
      id: version
      run: |
        if [ -f version.txt ]; then
          VERSION=$(cat version.txt | tr -d '\n\r')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ“ Version: $VERSION"
        else
          echo "version=1.0.0" >> $GITHUB_OUTPUT
          echo "1.0.0" > version.txt
          echo "âš  Created version.txt with 1.0.0"
        fi
    
    - name: ðŸ”¨ Build firmware
      run: |
        echo "Building ESP32 firmware..."
        
        # TÃ¬m file .ino (cáº£ trong thÆ° má»¥c con)
        INO_FILE=$(find . -name "*.ino" | head -n 1)
        
        if [ -z "$INO_FILE" ]; then
          echo "âŒ No .ino file found!"
          exit 1
        fi
        
        echo "Found sketch: $INO_FILE"
        
        # Láº¥y thÆ° má»¥c chá»©a file .ino
        SKETCH_DIR=$(dirname "$INO_FILE")
        
        echo "Sketch directory: $SKETCH_DIR"
        
        arduino-cli compile \
          --fqbn esp32:esp32:esp32 \
          --output-dir build \
          "$SKETCH_DIR"
        
        BIN_FILE=$(find build -name "*.bin" | head -n 1)
        
        if [ -z "$BIN_FILE" ]; then
          echo "âŒ No .bin file generated!"
          exit 1
        fi
        
        cp "$BIN_FILE" firmware.bin
        
        SIZE=$(stat -c%s firmware.bin 2>/dev/null || stat -f%z firmware.bin)
        echo "âœ“ Firmware built successfully!"
        echo "âœ“ Size: $SIZE bytes"
        ls -lh firmware.bin
    
    - name: ðŸ“¤ Commit firmware
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        
        git add firmware.bin version.txt
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit"
          exit 0
        fi
        
        VERSION="${{ steps.version.outputs.version }}"
        git commit -m "ðŸš€ Auto build firmware v$VERSION [skip ci]"
        
        echo "âœ“ Committed firmware v$VERSION"
    
    - name: ðŸš€ Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
    
    - name: ðŸ“ Summary
      run: |
        echo "## âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Firmware Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        SIZE=$(stat -c%s firmware.bin 2>/dev/null || stat -f%z firmware.bin)
        echo "- **Size:** $SIZE bytes" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— OTA URLs" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "https://raw.githubusercontent.com/${{ github.repository }}/main/firmware.bin" >> $GITHUB_STEP_SUMMARY
        echo "https://raw.githubusercontent.com/${{ github.repository }}/main/version.txt" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± ESP32 will auto-update within 6 hours" >> $GITHUB_STEP_SUMMARY