name: ESP32 Multi-Board Build & Release

on:
  push:
    branches: [main]
    paths:
      - 'ESP32_Power_Monitor/**'
      - 'ESP32C6_Power_Monitor/**'
      - 'version.txt'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          # ESP32 Classic (WROOM)
          - board: esp32
            fqbn: "esp32:esp32:esp32:PartitionScheme=min_spiffs,FlashSize=4M"
            folder: "ESP32_Power_Monitor"
            sketch: "ESP32_Power_Monitor.ino"
            output: "firmware-esp32.bin"
            chip: "ESP32 Classic"
          
          # ESP32-C6
          - board: esp32c6
            fqbn: "esp32:esp32:esp32c6:PartitionScheme=min_spiffs,FlashSize=4M"
            folder: "ESP32C6_Power_Monitor"
            sketch: "ESP32C6_Power_Monitor.ino"
            output: "firmware-esp32c6.bin"
            chip: "ESP32-C6"
    
    name: Build ${{ matrix.chip }}
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1
    
    - name: ðŸ“¦ Install ESP32 Core
      run: |
        arduino-cli config init
        arduino-cli core update-index
        
        # Install ESP32 core vá»›i support cho C6
        arduino-cli core install esp32:esp32@3.0.7
        
        echo "âœ“ Installed ESP32 core 3.0.7"
        echo "âœ“ Supports: ESP32, ESP32-S2, ESP32-S3, ESP32-C3, ESP32-C6"
    
    - name: ðŸ“– Read Version
      id: version
      run: |
        if [ -f version.txt ]; then
          VERSION=$(cat version.txt | tr -d '\n\r')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ“ Version: $VERSION"
        else
          echo "version=1.0.0" >> $GITHUB_OUTPUT
          echo "1.0.0" > version.txt
          echo "âš  Created version.txt with 1.0.0"
        fi
    
    - name: ðŸ” Check Sketch Exists
      run: |
        SKETCH_PATH="${{ matrix.folder }}/${{ matrix.sketch }}"
        
        if [ ! -f "$SKETCH_PATH" ]; then
          echo "âŒ Sketch not found: $SKETCH_PATH"
          echo "Available files in ${{ matrix.folder }}/:"
          ls -la ${{ matrix.folder }}/ || echo "Folder not found!"
          exit 1
        fi
        
        echo "âœ“ Found sketch: $SKETCH_PATH"
    
    - name: ðŸ”¨ Build Firmware for ${{ matrix.chip }}
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  Building for ${{ matrix.chip }}"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        echo "Board: ${{ matrix.fqbn }}"
        echo "Folder: ${{ matrix.folder }}"
        echo "Sketch: ${{ matrix.sketch }}"
        
        # Build (Arduino CLI compile folder chá»©a .ino file)
        arduino-cli compile \
          --fqbn "${{ matrix.fqbn }}" \
          --output-dir "build-${{ matrix.board }}" \
          --verbose \
          "${{ matrix.folder }}"
        
        echo ""
        echo "Build directory contents:"
        ls -lh "build-${{ matrix.board }}/"
        
        # Find the SMALLEST .bin file (actual firmware without padding)
        # Exclude bootloader and partitions
        BIN_FILES=$(find "build-${{ matrix.board }}" -name "*.bin" | grep -v "bootloader" | grep -v "partitions")
        
        if [ -z "$BIN_FILES" ]; then
          echo "âŒ No .bin file generated!"
          exit 1
        fi
        
        echo ""
        echo "Available .bin files:"
        for file in $BIN_FILES; do
          size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
          size_kb=$(echo "scale=2; $size/1024" | bc)
          echo "  - $file ($size_kb KB)"
        done
        
        # Get the smallest file (actual firmware)
        BIN_FILE=$(ls -S $BIN_FILES | tail -1)
        
        echo ""
        echo "Selected binary: $BIN_FILE"
        cp "$BIN_FILE" "${{ matrix.output }}"
        
        # Verify
        SIZE=$(stat -c%s "${{ matrix.output }}" 2>/dev/null || stat -f%z "${{ matrix.output }}")
        MAGIC=$(xxd -p -l 1 "${{ matrix.output }}")
        
        echo ""
        echo "âœ“ Firmware built successfully!"
        echo "âœ“ Output: ${{ matrix.output }}"
        echo "âœ“ Size: $SIZE bytes ($(echo "scale=2; $SIZE/1024" | bc) KB)"
        echo "âœ“ Magic number: 0x$MAGIC"
        
        if [ $SIZE -lt 100000 ]; then
          echo "âŒ Error: Firmware too small ($SIZE bytes)"
          exit 1
        fi
        
        ls -lh "${{ matrix.output }}"
        echo "First 64 bytes:"
        xxd -l 64 "${{ matrix.output }}"
    
    - name: âœ… Verify Firmware
      run: |
        echo "=== Firmware Verification for ${{ matrix.chip }} ==="
        
        SIZE=$(stat -c%s "${{ matrix.output }}" 2>/dev/null || stat -f%z "${{ matrix.output }}")
        echo "Size: $SIZE bytes ($(echo "scale=2; $SIZE/1024" | bc) KB)"
        
        if [ $SIZE -lt 100000 ]; then
          echo "âŒ File too small!"
          exit 1
        fi
        
        MAGIC=$(xxd -p -l 1 "${{ matrix.output }}")
        echo "Magic: 0x$MAGIC"
        
        if [ "$MAGIC" = "e9" ]; then
          echo "âœ“ Valid ESP32 firmware"
        else
          echo "âš ï¸ Warning: Unexpected magic number (expected 0xE9)"
        fi
        
        echo "First 32 bytes:"
        xxd -l 32 "${{ matrix.output }}"
    
    - name: ðŸ“¤ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ matrix.board }}
        path: ${{ matrix.output }}
        retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ðŸ“– Read Version
      id: version
      run: |
        VERSION=$(cat version.txt | tr -d '\n\r')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: ðŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: ðŸ“¦ Prepare Release Files
      run: |
        echo "Organizing release files..."
        
        # ESP32 Classic
        if [ -f "artifacts/firmware-esp32/firmware-esp32.bin" ]; then
          cp "artifacts/firmware-esp32/firmware-esp32.bin" "firmware-esp32.bin"
          SIZE_ESP32=$(stat -c%s firmware-esp32.bin 2>/dev/null || stat -f%z firmware-esp32.bin)
          SIZE_ESP32_KB=$(echo "scale=2; $SIZE_ESP32/1024" | bc)
          echo "âœ“ ESP32 firmware ready: $SIZE_ESP32_KB KB"
          echo "SIZE_ESP32=$SIZE_ESP32" >> $GITHUB_ENV
          echo "SIZE_ESP32_KB=$SIZE_ESP32_KB" >> $GITHUB_ENV
        else
          echo "âŒ ESP32 firmware not found!"
          exit 1
        fi
        
        # ESP32-C6
        if [ -f "artifacts/firmware-esp32c6/firmware-esp32c6.bin" ]; then
          cp "artifacts/firmware-esp32c6/firmware-esp32c6.bin" "firmware-esp32c6.bin"
          SIZE_C6=$(stat -c%s firmware-esp32c6.bin 2>/dev/null || stat -f%z firmware-esp32c6.bin)
          SIZE_C6_KB=$(echo "scale=2; $SIZE_C6/1024" | bc)
          echo "âœ“ ESP32-C6 firmware ready: $SIZE_C6_KB KB"
          echo "SIZE_C6=$SIZE_C6" >> $GITHUB_ENV
          echo "SIZE_C6_KB=$SIZE_C6_KB" >> $GITHUB_ENV
        else
          echo "âŒ ESP32-C6 firmware not found!"
          exit 1
        fi
        
        # version.txt already exists in root, no need to copy
        
        echo ""
        echo "Files for release:"
        ls -lh firmware-*.bin version.txt
        
        # Validation: Check if ESP32 firmware is suspiciously large (4MB = full partition)
        if [ $SIZE_ESP32 -ge 4000000 ]; then
          echo "âš ï¸  WARNING: ESP32 firmware is 4MB (full partition size)"
          echo "    This might indicate the build included padding"
          echo "    Expected size: 200-800 KB for typical firmware"
        fi
    
    - name: ðŸ“¤ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Release v${{ steps.version.outputs.version }}
        body: |
          ## ðŸŽ‰ ESP32 Power Monitor v${{ steps.version.outputs.version }}
          
          ### ðŸ“¦ Firmware Files
          
          | Board | File | Size | Download |
          |-------|------|------|----------|
          | **ESP32 Classic (WROOM)** | `firmware-esp32.bin` | ${{ env.SIZE_ESP32_KB }} KB | â¬‡ï¸ [Download](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/firmware-esp32.bin) |
          | **ESP32-C6** | `firmware-esp32c6.bin` | ${{ env.SIZE_C6_KB }} KB | â¬‡ï¸ [Download](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/firmware-esp32c6.bin) |
          | **Version File** | `version.txt` | - | â¬‡ï¸ [Download](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/version.txt) |
          
          ---
          
          ### ðŸ”— OTA URLs (Always Latest)
          
          #### For ESP32 Classic (WROOM)
          ```
          Version URL:
          https://github.com/${{ github.repository }}/releases/latest/download/version.txt
          
          Binary URL:
          https://github.com/${{ github.repository }}/releases/latest/download/firmware-esp32.bin
          ```
          
          #### For ESP32-C6
          ```
          Version URL:
          https://github.com/${{ github.repository }}/releases/latest/download/version.txt
          
          Binary URL:
          https://github.com/${{ github.repository }}/releases/latest/download/firmware-esp32c6.bin
          ```
          
          > âš ï¸ **Important:** Make sure you use the correct binary URL for your board type!
          
          ---
          
          ### ðŸ“± First Time Setup
          
          1. **Uncomment** in your `.ino` file:
             ```cpp
             #define FIRST_TIME_SETUP
             ```
          
          2. **Upload** to ESP32 and open Serial Monitor (115200 baud)
          
          3. **Enter credentials:**
             - WiFi SSID & Password
             - Webhook & Telegram credentials
             - **Version URL:** (same for both boards)
               ```
               https://github.com/${{ github.repository }}/releases/latest/download/version.txt
               ```
             - **Binary URL:** (choose based on your board)
               - **ESP32 Classic:** `firmware-esp32.bin`
               - **ESP32-C6:** `firmware-esp32c6.bin`
          
          4. **Comment out** `#define FIRST_TIME_SETUP` and upload again
          
          5. **Done!** Auto-update every 6 hours ðŸŽ‰
          
          ---
          
          ðŸ¤– *Built with GitHub Actions*
          
          ðŸ“… *Commit: `${{ github.sha }}`*
        files: |
          firmware-esp32.bin
          firmware-esp32c6.bin
          version.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ“ Job Summary
      run: |
        echo "## âœ… Multi-Board Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“¦ Firmware Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“Š Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Board | File | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ESP32 Classic | firmware-esp32.bin | ${{ env.SIZE_ESP32_KB }} KB |" >> $GITHUB_STEP_SUMMARY
        echo "| ESP32-C6 | firmware-esp32c6.bin | ${{ env.SIZE_C6_KB }} KB |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ”— OTA URLs" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ESP32 Classic:**" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "https://github.com/${{ github.repository }}/releases/latest/download/firmware-esp32.bin" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ESP32-C6:**" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "https://github.com/${{ github.repository }}/releases/latest/download/firmware-esp32c6.bin" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### âœ… Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“± ESP32 devices will auto-update within 6 hours" >> $GITHUB_STEP_SUMMARY