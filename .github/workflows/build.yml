name: ESP32 Build & Release

on:
  push:
    branches: [main]
    paths:
      - '**.ino'
      - '**.cpp'
      - '**.h'
      - 'version.txt'
  workflow_dispatch:x

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1
    
    - name: ðŸ“¦ Install ESP32 Core
      run: |
        arduino-cli config init
        arduino-cli core update-index
        arduino-cli core install esp32:esp32@2.0.17
        echo "âœ“ Installed ESP32 core 2.0.17"
    
    - name: ðŸ“– Read Version
      id: version
      run: |
        if [ -f version.txt ]; then
          VERSION=$(cat version.txt | tr -d '\n\r')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ“ Version: $VERSION"
        else
          echo "version=1.0.0" >> $GITHUB_OUTPUT
          echo "1.0.0" > version.txt
          echo "âš  Created version.txt with 1.0.0"
        fi
    
    - name: ðŸ”¨ Build Firmware
      run: |
        echo "Building ESP32 firmware..."
        
        # Find .ino file
        INO_FILE=$(find . -name "*.ino" | head -n 1)
        
        if [ -z "$INO_FILE" ]; then
          echo "âŒ No .ino file found!"
          exit 1
        fi
        
        echo "Found sketch: $INO_FILE"
        SKETCH_DIR=$(dirname "$INO_FILE")
        echo "Sketch directory: $SKETCH_DIR"
        
        # Build with partition scheme
        arduino-cli compile \
          --fqbn esp32:esp32:esp32:PartitionScheme=min_spiffs,FlashSize=4M \
          --output-dir build \
          --verbose \
          "$SKETCH_DIR"
        
        # Find .bin file
        BIN_FILE=$(find build -name "*.ino.bin" -o -name "*.bin" | grep -v "bootloader" | grep -v "partitions" | head -n 1)
        
        if [ -z "$BIN_FILE" ]; then
          echo "âŒ No .bin file generated!"
          echo "Files in build directory:"
          ls -la build/
          exit 1
        fi
        
        echo "Found binary: $BIN_FILE"
        cp "$BIN_FILE" firmware.bin
        
        # Verify
        SIZE=$(stat -c%s firmware.bin 2>/dev/null || stat -f%z firmware.bin)
        MAGIC=$(xxd -p -l 1 firmware.bin)
        
        echo "âœ“ Firmware built successfully!"
        echo "âœ“ Size: $SIZE bytes ($(echo "scale=2; $SIZE/1024" | bc) KB)"
        echo "âœ“ Magic number: 0x$MAGIC"
        
        if [ "$MAGIC" != "e9" ]; then
          echo "âš ï¸ Warning: Magic number should be 0xE9 for ESP32"
        fi
        
        if [ $SIZE -lt 100000 ]; then
          echo "âŒ Error: Firmware too small ($SIZE bytes)"
          exit 1
        fi
        
        ls -lh firmware.bin
        xxd -l 64 firmware.bin
    
    - name: âœ… Verify Firmware
      run: |
        echo "=== Firmware Verification ==="
        
        SIZE=$(stat -c%s firmware.bin 2>/dev/null || stat -f%z firmware.bin)
        echo "Size: $SIZE bytes"
        
        if [ $SIZE -lt 100000 ]; then
          echo "âŒ File too small!"
          exit 1
        fi
        
        MAGIC=$(xxd -p -l 1 firmware.bin)
        echo "Magic: 0x$MAGIC"
        
        if [ "$MAGIC" = "e9" ]; then
          echo "âœ“ Valid ESP32 firmware"
        else
          echo "âš ï¸ Warning: Unexpected magic number"
        fi
        
        echo "First 32 bytes:"
        xxd -l 32 firmware.bin
    
    - name: ðŸ“¤ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Release v${{ steps.version.outputs.version }}
        body: |
          ## ESP32 Power Monitor v${{ steps.version.outputs.version }}
          
          ### ðŸ“¦ Files
          - `firmware.bin` - ESP32 firmware binary
          - `version.txt` - Version file
          
          ### ðŸ”— OTA URLs (Always Latest)
          ```
          https://github.com/${{ github.repository }}/releases/latest/download/firmware.bin
          https://github.com/${{ github.repository }}/releases/latest/download/version.txt
          ```
          
          ### ðŸ”— This Version URLs
          ```
          https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/firmware.bin
          https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/version.txt
          ```
          
          ### ðŸ“± Installation
          Flash using esptool or let ESP32 auto-update via OTA.
          
          ---
          *Built with GitHub Actions*
        files: |
          firmware.bin
          version.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ“ Job Summary
      run: |
        echo "## âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Firmware Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        
        SIZE=$(stat -c%s firmware.bin 2>/dev/null || stat -f%z firmware.bin)
        SIZE_KB=$(echo "scale=2; $SIZE/1024" | bc)
        echo "- **Size:** $SIZE bytes ($SIZE_KB KB)" >> $GITHUB_STEP_SUMMARY
        
        MAGIC=$(xxd -p -l 1 firmware.bin)
        echo "- **Magic:** 0x$MAGIC" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ”— Release URLs" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "Latest: https://github.com/${{ github.repository }}/releases/latest/download/firmware.bin" >> $GITHUB_STEP_SUMMARY
        echo "This:   https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/firmware.bin" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$MAGIC" = "e9" ] && [ $SIZE -gt 100000 ]; then
          echo "### âœ… Firmware validation: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“± ESP32 will auto-update within 6 hours" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ Firmware validation: WARNING" >> $GITHUB_STEP_SUMMARY
        fi