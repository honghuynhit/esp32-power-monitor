name: ESP32 Multi-Board Build & Release

on:
  push:
    branches: [main]
    paths:
      - 'ESP32_Power_Monitor/**'
      - 'version.txt'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          # ESP32 Classic (WROOM)
          - board: esp32
            fqbn: "esp32:esp32:esp32:PartitionScheme=min_spiffs,FlashSize=4M"
            sketch: "ESP32_Power_Monitor.ino"
            output: "firmware-esp32.bin"
            chip: "ESP32 Classic"
          
          # ESP32-C6
          - board: esp32c6
            fqbn: "esp32:esp32:esp32c6:PartitionScheme=min_spiffs,FlashSize=4M"
            sketch: "ESP32C6_Power_monitor.ino"
            output: "firmware-esp32c6.bin"
            chip: "ESP32-C6"
    
    name: Build ${{ matrix.chip }}
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1
    
    - name: ðŸ“¦ Install ESP32 Core
      run: |
        arduino-cli config init
        arduino-cli core update-index
        
        # Install ESP32 core vá»›i support cho C6
        arduino-cli core install esp32:esp32@3.0.7
        
        echo "âœ“ Installed ESP32 core 3.0.7"
        echo "âœ“ Supports: ESP32, ESP32-S2, ESP32-S3, ESP32-C3, ESP32-C6"
    
    - name: ðŸ“– Read Version
      id: version
      run: |
        if [ -f version.txt ]; then
          VERSION=$(cat version.txt | tr -d '\n\r')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ“ Version: $VERSION"
        else
          echo "version=1.0.0" >> $GITHUB_OUTPUT
          echo "1.0.0" > version.txt
          echo "âš  Created version.txt with 1.0.0"
        fi
    
    - name: ðŸ” Check Sketch Exists
      run: |
        SKETCH_PATH="ESP32_Power_Monitor/${{ matrix.sketch }}"
        
        if [ ! -f "$SKETCH_PATH" ]; then
          echo "âŒ Sketch not found: $SKETCH_PATH"
          echo "Available files in ESP32_Power_Monitor/:"
          ls -la ESP32_Power_Monitor/
          exit 1
        fi
        
        echo "âœ“ Found sketch: $SKETCH_PATH"
    
    - name: ðŸ”¨ Build Firmware for ${{ matrix.chip }}
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  Building for ${{ matrix.chip }}"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        echo "Board: ${{ matrix.fqbn }}"
        echo "Sketch: ESP32_Power_Monitor/${{ matrix.sketch }}"
        
        # Build (Arduino CLI cáº§n thÆ° má»¥c chá»©a file .ino)
        arduino-cli compile \
          --fqbn "${{ matrix.fqbn }}" \
          --output-dir "build-${{ matrix.board }}" \
          --verbose \
          ESP32_Power_Monitor/${{ matrix.sketch }}
        
        # Find .bin file (bá» qua bootloader vÃ  partitions)
        BIN_FILE=$(find "build-${{ matrix.board }}" -name "*.ino.bin" -o -name "*.bin" | grep -v "bootloader" | grep -v "partitions" | head -n 1)
        
        if [ -z "$BIN_FILE" ]; then
          echo "âŒ No .bin file generated!"
          echo "Files in build directory:"
          ls -la "build-${{ matrix.board }}/"
          exit 1
        fi
        
        echo "Found binary: $BIN_FILE"
        cp "$BIN_FILE" "${{ matrix.output }}"
        
        # Verify
        SIZE=$(stat -c%s "${{ matrix.output }}" 2>/dev/null || stat -f%z "${{ matrix.output }}")
        MAGIC=$(xxd -p -l 1 "${{ matrix.output }}")
        
        echo ""
        echo "âœ“ Firmware built successfully!"
        echo "âœ“ Output: ${{ matrix.output }}"
        echo "âœ“ Size: $SIZE bytes ($(echo "scale=2; $SIZE/1024" | bc) KB)"
        echo "âœ“ Magic number: 0x$MAGIC"
        
        if [ $SIZE -lt 100000 ]; then
          echo "âŒ Error: Firmware too small ($SIZE bytes)"
          exit 1
        fi
        
        ls -lh "${{ matrix.output }}"
        echo "First 64 bytes:"
        xxd -l 64 "${{ matrix.output }}"
    
    - name: âœ… Verify Firmware
      run: |
        echo "=== Firmware Verification for ${{ matrix.chip }} ==="
        
        SIZE=$(stat -c%s "${{ matrix.output }}" 2>/dev/null || stat -f%z "${{ matrix.output }}")
        echo "Size: $SIZE bytes ($(echo "scale=2; $SIZE/1024" | bc) KB)"
        
        if [ $SIZE -lt 100000 ]; then
          echo "âŒ File too small!"
          exit 1
        fi
        
        MAGIC=$(xxd -p -l 1 "${{ matrix.output }}")
        echo "Magic: 0x$MAGIC"
        
        if [ "$MAGIC" = "e9" ]; then
          echo "âœ“ Valid ESP32 firmware"
        else
          echo "âš ï¸ Warning: Unexpected magic number (expected 0xE9)"
        fi
        
        echo "First 32 bytes:"
        xxd -l 32 "${{ matrix.output }}"
    
    - name: ðŸ“¤ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ matrix.board }}
        path: ${{ matrix.output }}
        retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ðŸ“– Read Version
      id: version
      run: |
        VERSION=$(cat version.txt | tr -d '\n\r')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: ðŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: ðŸ“¦ Prepare Release Files
      run: |
        echo "Organizing release files..."
        
        # ESP32 Classic
        if [ -f "artifacts/firmware-esp32/firmware-esp32.bin" ]; then
          cp "artifacts/firmware-esp32/firmware-esp32.bin" "firmware-esp32.bin"
          SIZE_ESP32=$(stat -c%s firmware-esp32.bin 2>/dev/null || stat -f%z firmware-esp32.bin)
          SIZE_ESP32_KB=$(echo "scale=2; $SIZE_ESP32/1024" | bc)
          echo "âœ“ ESP32 firmware ready: $SIZE_ESP32_KB KB"
          echo "SIZE_ESP32=$SIZE_ESP32" >> $GITHUB_ENV
          echo "SIZE_ESP32_KB=$SIZE_ESP32_KB" >> $GITHUB_ENV
        fi
        
        # ESP32-C6
        if [ -f "artifacts/firmware-esp32c6/firmware-esp32c6.bin" ]; then
          cp "artifacts/firmware-esp32c6/firmware-esp32c6.bin" "firmware-esp32c6.bin"
          SIZE_C6=$(stat -c%s firmware-esp32c6.bin 2>/dev/null || stat -f%z firmware-esp32c6.bin)
          SIZE_C6_KB=$(echo "scale=2; $SIZE_C6/1024" | bc)
          echo "âœ“ ESP32-C6 firmware ready: $SIZE_C6_KB KB"
          echo "SIZE_C6=$SIZE_C6" >> $GITHUB_ENV
          echo "SIZE_C6_KB=$SIZE_C6_KB" >> $GITHUB_ENV
        fi
        
        # Copy version.txt
        cp version.txt version.txt
        
        echo ""
        echo "Files for release:"
        ls -lh firmware-*.bin version.txt
    
    - name: ðŸ“¤ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Release v${{ steps.version.outputs.version }}
        body: |
          ## ðŸŽ‰ ESP32 Power Monitor v${{ steps.version.outputs.version }}
          
          ### ðŸ“¦ Firmware Files
          
          | Board | File | Size | Download |
          |-------|------|------|----------|
          | **ESP32 Classic (WROOM)** | `firmware-esp32.bin` | ${{ env.SIZE_ESP32_KB }} KB | â¬‡ï¸ [Download](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/firmware-esp32.bin) |
          | **ESP32-C6** | `firmware-esp32c6.bin` | ${{ env.SIZE_C6_KB }} KB | â¬‡ï¸ [Download](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/firmware-esp32c6.bin) |
          | **Version File** | `version.txt` | - | â¬‡ï¸ [Download](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/version.txt) |
          
          ---
          
          ### ðŸ”— OTA URLs (Always Latest)
          
          #### For ESP32 Classic (WROOM)
          ```
          Version URL:
          https://github.com/${{ github.repository }}/releases/latest/download/version.txt
          
          Binary URL:
          https://github.com/${{ github.repository }}/releases/latest/download/firmware-esp32.bin
          ```
          
          #### For ESP32-C6
          ```
          Version URL:
          https://github.com/${{ github.repository }}/releases/latest/download/version.txt
          
          Binary URL:
          https://github.com/${{ github.repository }}/releases/latest/download/firmware-esp32c6.bin
          ```
          
          > âš ï¸ **Important:** Make sure you use the correct binary URL for your board type!
          
          ---
          
          ### ðŸ“± Setup Instructions
          
          #### First Time Setup (Both Boards)
          
          1. **Uncomment** in your `.ino` file:
             ```cpp
             #define FIRST_TIME_SETUP
             ```
          
          2. **Upload** to ESP32
          
          3. **Open Serial Monitor** (115200 baud) and enter:
             - WiFi credentials
             - Webhook URL
             - Telegram bot token & chat ID
             - **Version URL:** (same for both boards)
               ```
               https://github.com/${{ github.repository }}/releases/latest/download/version.txt
               ```
             - **Binary URL:** (choose based on your board)
               - ESP32 Classic:
                 ```
                 https://github.com/${{ github.repository }}/releases/latest/download/firmware-esp32.bin
                 ```
               - ESP32-C6:
                 ```
                 https://github.com/${{ github.repository }}/releases/latest/download/firmware-esp32c6.bin
                 ```
          
          4. **Comment out** `#define FIRST_TIME_SETUP` and upload again
          
          5. **Done!** Device will auto-update every 6 hours
          
          ---
          
          ### ðŸ“¥ Manual Flash via esptool
          
          **ESP32 Classic:**
          ```bash
          esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 921600 \
            write_flash -z 0x10000 firmware-esp32.bin
          ```
          
          **ESP32-C6:**
          ```bash
          esptool.py --chip esp32c6 --port /dev/ttyUSB0 --baud 921600 \
            write_flash 0x0 firmware-esp32c6.bin
          ```
          
          ---
          
          ### ðŸ”„ Auto-Update Features
          
          - âœ… Automatic update check every **6 hours**
          - âœ… Update check on **device restart**
          - âœ… **Telegram notification** when update available
          - âœ… **Progress bar** during download
          - âœ… **Automatic rollback** if update fails
          
          ---
          
          ### ðŸ“‹ What's Included
          
          - âš¡ Power monitoring with daily count
          - ðŸŒ™ Night-time alerts (21:30, every 15 min)
          - â° Long-run alerts (>3h, every 30 min)
          - ðŸ“± Telegram notifications
          - ðŸ“Š Google Sheets logging
          - ðŸ”„ OTA updates via GitHub Releases
          - ðŸ’¾ NVRAM credentials storage
          
          ---
          
          ### ðŸ› Troubleshooting
          
          **Wrong firmware downloaded?**
          - Check Serial Monitor: `Current chip: ESP32` or `ESP32-C6`
          - Make sure Binary URL matches your chip
          
          **Update failed with "mismatch chip ID"?**
          - You're using wrong firmware binary
          - ESP32 Classic needs `firmware-esp32.bin`
          - ESP32-C6 needs `firmware-esp32c6.bin`
          
          **Need help?**
          - Check Serial Monitor output (115200 baud)
          - Open an [issue](https://github.com/${{ github.repository }}/issues)
          
          ---
          
          ðŸ¤– *Built automatically with GitHub Actions*
          
          ðŸ“… *Commit: `${{ github.sha }}`*
        files: |
          firmware-esp32.bin
          firmware-esp32c6.bin
          version.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ“ Job Summary
      run: |
        echo "## âœ… Multi-Board Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“¦ Firmware Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“Š Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Board | File | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ESP32 Classic | firmware-esp32.bin | ${{ env.SIZE_ESP32_KB }} KB |" >> $GITHUB_STEP_SUMMARY
        echo "| ESP32-C6 | firmware-esp32c6.bin | ${{ env.SIZE_C6_KB }} KB |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ”— OTA URLs" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ESP32 Classic:**" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "https://github.com/${{ github.repository }}/releases/latest/download/firmware-esp32.bin" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ESP32-C6:**" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "https://github.com/${{ github.repository }}/releases/latest/download/firmware-esp32c6.bin" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### âœ… Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. âœ… Release created: [v${{ steps.version.outputs.version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
        echo "2. ðŸ“± ESP32 devices will auto-update within 6 hours" >> $GITHUB_STEP_SUMMARY
        echo "3. ðŸ”„ Or restart devices to update immediately" >> $GITHUB_STEP_SUMMARY